---
import Layout from '../../layouts/Layout.astro';
import Container from '../../components/layout/Container.astro';
import Section from '../../components/layout/Section.astro';
import Navigation from '../../components/layout/Navigation';
import Footer from '../../components/layout/Footer';
import ScrollProgress from '../../components/effects/ScrollProgress';
import { getCollection } from 'astro:content';

export async function getStaticPaths() {
  const posts = await getCollection('blog');
  return posts.map(post => ({
    params: { slug: post.slug },
    props: { post },
  }));
}

const { post } = Astro.props;
const { Content, headings } = await post.render();
const allPosts = await getCollection('blog');
const related = allPosts
  .filter(p => p.slug !== post.slug)
  .sort((a, b) => (a.data.category === post.data.category ? -1 : 1))
  .slice(0, 3);

function formatDate(date: Date) {
  return date.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
}

const toc = headings.filter(h => h.depth <= 3);
---

<Layout
  title={`${post.data.title} ‚Äî NexusAI Blog`}
  description={post.data.excerpt}
>
  <ScrollProgress client:load />
  <Navigation client:load links={[
    { label: "Features", href: "/ai-saas-premium/features/" },
    { label: "Pricing", href: "/ai-saas-premium/pricing/" },
    { label: "About", href: "/ai-saas-premium/about/" },
    { label: "Contact", href: "/ai-saas-premium/contact/" },
  ]} />

  <!-- Article Header -->
  <Section size="lg" class="page-hero">
    <div class="hero-bg" aria-hidden="true">
      <div class="grid-bg"></div>
      <div class="gradient-orb gradient-orb--purple"></div>
    </div>
    <Container>
      <div style="position: relative; z-index: 1; max-width: 720px; margin: 0 auto; text-align: center;">
        <nav class="breadcrumbs fade-up" aria-label="Breadcrumb">
          <a href={import.meta.env.BASE_URL}>Home</a>
          <span class="sep">/</span>
          <a href={import.meta.env.BASE_URL + 'blog/'}>Blog</a>
          <span class="sep">/</span>
          <span class="current">{post.data.category}</span>
        </nav>
        <span class="category-tag fade-up">{post.data.category}</span>
        <h1 class="fade-up" style="margin: var(--space-4) 0; line-height: 1.15;">
          {post.data.title}
        </h1>
        <div class="article-meta fade-up delay-1">
          <div class="author-info">
            <div class="avatar">{post.data.author[0]}</div>
            <div>
              <span class="author-name">{post.data.author}</span>
              {post.data.authorRole && <span class="author-role">{post.data.authorRole}</span>}
            </div>
          </div>
          <span class="meta-sep">¬∑</span>
          <time datetime={post.data.date.toISOString()}>{formatDate(post.data.date)}</time>
          <span class="meta-sep">¬∑</span>
          <span>{post.data.readTime}</span>
        </div>
      </div>
    </Container>
  </Section>

  <!-- Article Body + TOC -->
  <Section>
    <Container>
      <div class="article-layout">
        <!-- TOC Sidebar -->
        {toc.length > 0 && (
          <aside class="toc-sidebar">
            <div class="toc-card">
              <h4 class="toc-title">Table of Contents</h4>
              <nav>
                <ul class="toc-list">
                  {toc.map(h => (
                    <li class={`toc-item toc-item--${h.depth}`}>
                      <a href={`#${h.slug}`}>{h.text}</a>
                    </li>
                  ))}
                </ul>
              </nav>
            </div>
          </aside>
        )}

        <!-- Article Content -->
        <article class="article-content">
          <Content />

          <!-- Share Buttons -->
          <div class="share-bar">
            <span class="share-label">Share this article</span>
            <div class="share-buttons">
              <a href={`https://twitter.com/intent/tweet?text=${encodeURIComponent(post.data.title)}&url=${encodeURIComponent(`https://fpsjago.github.io/ai-saas-premium/blog/${post.slug}/`)}`} target="_blank" rel="noopener" class="share-btn" aria-label="Share on Twitter">ùïè</a>
              <a href={`https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(`https://fpsjago.github.io/ai-saas-premium/blog/${post.slug}/`)}`} target="_blank" rel="noopener" class="share-btn" aria-label="Share on LinkedIn">in</a>
            </div>
          </div>

          <!-- Author Card -->
          <div class="author-card">
            <div class="avatar avatar--lg">{post.data.author[0]}</div>
            <div>
              <h4 class="author-card__name">{post.data.author}</h4>
              {post.data.authorRole && <p class="author-card__role">{post.data.authorRole}</p>}
              <p class="author-card__bio">Writing about developer tools, AI infrastructure, and engineering best practices at NexusAI.</p>
            </div>
          </div>
        </article>
      </div>
    </Container>
  </Section>

  <!-- Related Posts -->
  <Section>
    <Container>
      <h2 class="fade-up" style="text-align: center; margin-bottom: var(--space-8);">Related Articles</h2>
      <div class="related-grid">
        {related.map(p => (
          <a href={`/ai-saas-premium/blog/${p.slug}/`} class="blog-card fade-up">
            <span class="category-tag category-tag--sm">{p.data.category}</span>
            <h3 class="blog-card__title">{p.data.title}</h3>
            <p class="blog-card__excerpt">{p.data.excerpt}</p>
            <span class="blog-card__meta">{p.data.author} ¬∑ {p.data.readTime}</span>
          </a>
        ))}
      </div>
    </Container>
  </Section>

  <!-- Newsletter -->
  <Section>
    <Container>
      <div class="newsletter-cta fade-up">
        <h2><span class="gradient-text">Never miss an update</span></h2>
        <p style="color: var(--text-secondary); margin-bottom: var(--space-6);">
          Subscribe to our newsletter for the latest articles and engineering insights.
        </p>
        <form class="newsletter-inline" onsubmit="event.preventDefault()">
          <input type="email" placeholder="your@email.com" class="newsletter-input" required />
          <button type="submit" class="btn btn--primary">Subscribe</button>
        </form>
      </div>
    </Container>
  </Section>

  <Footer client:load />
</Layout>

<style>
  .page-hero { position: relative; overflow: hidden; }
  .hero-bg { position: absolute; inset: 0; z-index: 0; }
  .grid-bg {
    position: absolute; inset: 0;
    background-image: linear-gradient(var(--border) 1px, transparent 1px),
                      linear-gradient(90deg, var(--border) 1px, transparent 1px);
    background-size: 60px 60px;
    mask-image: radial-gradient(ellipse at center, black 30%, transparent 70%);
    opacity: 0.4;
  }
  .gradient-orb--purple {
    position: absolute; top: 30%; left: 50%; transform: translate(-50%, -50%);
    width: 500px; height: 500px; border-radius: 50%;
    background: rgba(139, 92, 246, 0.1); filter: blur(80px);
  }
  .breadcrumbs { margin-bottom: var(--space-6); font-size: var(--text-sm); color: var(--text-muted); }
  .breadcrumbs a { color: var(--text-secondary); text-decoration: none; }
  .breadcrumbs a:hover { color: var(--primary); }
  .breadcrumbs .sep { margin: 0 var(--space-2); }
  .breadcrumbs .current { color: var(--text); }

  .category-tag {
    display: inline-block;
    padding: var(--space-1) var(--space-3); border-radius: var(--radius-full);
    background: rgba(139, 92, 246, 0.15); color: var(--primary);
    font-size: var(--text-xs); font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em;
  }
  .category-tag--sm { font-size: 0.65rem; }

  .article-meta {
    display: flex; align-items: center; justify-content: center;
    gap: var(--space-3); font-size: var(--text-sm); color: var(--text-muted);
    flex-wrap: wrap;
  }
  .author-info { display: flex; align-items: center; gap: var(--space-2); }
  .author-name { font-weight: 600; color: var(--text); }
  .author-role { display: block; font-size: var(--text-xs); color: var(--text-muted); }
  .meta-sep { color: var(--border); }
  .avatar {
    width: 32px; height: 32px; border-radius: 50%;
    background: var(--gradient-primary); display: flex; align-items: center;
    justify-content: center; font-weight: 700; font-size: var(--text-sm); color: white; flex-shrink: 0;
  }
  .avatar--lg { width: 48px; height: 48px; font-size: 1.2rem; }

  .article-layout {
    display: grid; grid-template-columns: 200px 1fr; gap: var(--space-10);
    max-width: 960px; margin: 0 auto;
  }

  .toc-sidebar { position: sticky; top: var(--space-8); align-self: start; }
  .toc-card {
    background: var(--bg-card); border: 1px solid var(--border);
    border-radius: var(--radius-lg); padding: var(--space-5);
  }
  .toc-title { font-size: var(--text-sm); font-weight: 600; margin-bottom: var(--space-3); color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em; }
  .toc-list { list-style: none; padding: 0; }
  .toc-item { margin-bottom: var(--space-2); }
  .toc-item a { font-size: var(--text-xs); color: var(--text-muted); text-decoration: none; line-height: 1.4; display: block; }
  .toc-item a:hover { color: var(--primary); }
  .toc-item--2 { padding-left: 0; }
  .toc-item--3 { padding-left: var(--space-4); }

  .article-content {
    max-width: 720px; font-size: var(--text-body); line-height: 1.8;
  }
  .article-content :global(h2) {
    font-size: var(--text-h3); margin: var(--space-10) 0 var(--space-4); color: var(--text);
  }
  .article-content :global(h3) {
    font-size: var(--text-h4); margin: var(--space-8) 0 var(--space-3); color: var(--text);
  }
  .article-content :global(p) { margin-bottom: var(--space-4); color: var(--text-secondary); }
  .article-content :global(ul), .article-content :global(ol) {
    margin-bottom: var(--space-4); padding-left: var(--space-6); color: var(--text-secondary);
  }
  .article-content :global(li) { margin-bottom: var(--space-2); }
  .article-content :global(strong) { color: var(--text); }
  .article-content :global(pre) {
    background: var(--bg-card) !important; border: 1px solid var(--border);
    border-radius: var(--radius-lg); padding: var(--space-6);
    overflow-x: auto; margin-bottom: var(--space-6); font-size: var(--text-sm);
  }
  .article-content :global(code) { font-family: var(--font-mono); }
  .article-content :global(:not(pre) > code) {
    background: var(--bg-card); padding: 2px 6px; border-radius: var(--radius-sm);
    font-size: 0.9em;
  }
  .article-content :global(blockquote) {
    border-left: 3px solid var(--primary); padding: var(--space-4) var(--space-6);
    margin: var(--space-6) 0; background: var(--bg-card);
    border-radius: 0 var(--radius-lg) var(--radius-lg) 0;
  }

  .share-bar {
    display: flex; align-items: center; gap: var(--space-4);
    padding: var(--space-6) 0; margin-top: var(--space-8);
    border-top: 1px solid var(--border);
  }
  .share-label { font-size: var(--text-sm); color: var(--text-muted); }
  .share-buttons { display: flex; gap: var(--space-3); }
  .share-btn {
    width: 36px; height: 36px; border-radius: 50%;
    background: var(--bg-card); border: 1px solid var(--border);
    display: flex; align-items: center; justify-content: center;
    text-decoration: none; color: var(--text); font-weight: 700; font-size: var(--text-sm);
    transition: border-color 0.3s, background 0.3s;
  }
  .share-btn:hover { border-color: var(--primary); background: rgba(139, 92, 246, 0.1); }

  .author-card {
    display: flex; gap: var(--space-4); padding: var(--space-6);
    background: var(--bg-card); border: 1px solid var(--border);
    border-radius: var(--radius-lg); margin-top: var(--space-8);
  }
  .author-card__name { font-weight: 600; margin-bottom: var(--space-1); }
  .author-card__role { font-size: var(--text-sm); color: var(--primary); margin-bottom: var(--space-2); }
  .author-card__bio { font-size: var(--text-sm); color: var(--text-muted); }

  .related-grid {
    display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: var(--space-6);
  }
  .blog-card {
    display: flex; flex-direction: column; text-decoration: none; color: inherit;
    background: var(--bg-card); border: 1px solid var(--border);
    border-radius: var(--radius-lg); padding: var(--space-6);
    transition: border-color 0.3s, transform 0.3s;
  }
  .blog-card:hover { border-color: var(--primary); transform: translateY(-4px); }
  .blog-card__title { font-size: var(--text-h4); margin: var(--space-3) 0; line-height: 1.3; }
  .blog-card__excerpt { font-size: var(--text-sm); color: var(--text-secondary); flex: 1; margin-bottom: var(--space-4); }
  .blog-card__meta { font-size: var(--text-xs); color: var(--text-muted); }

  .newsletter-cta {
    text-align: center; padding: var(--space-12) var(--space-8);
    background: var(--bg-card); border: 1px solid var(--border);
    border-radius: var(--radius-xl);
  }
  .newsletter-cta h2 { margin-bottom: var(--space-4); }
  .newsletter-inline {
    display: flex; gap: var(--space-3); max-width: 400px; margin: 0 auto;
  }
  .newsletter-input {
    flex: 1; padding: var(--space-3); border-radius: var(--radius-full);
    border: 1px solid var(--border); background: var(--bg-elevated);
    color: var(--text); font-size: var(--text-sm);
  }
  .newsletter-input:focus { outline: none; border-color: var(--primary); }
  .btn { padding: var(--space-3) var(--space-6); border-radius: var(--radius-full); font-weight: 600; text-decoration: none; border: none; cursor: pointer; transition: transform 0.2s; }
  .btn--primary { background: var(--gradient-primary); color: white; }
  .btn--primary:hover { transform: translateY(-2px); }

  @media (max-width: 768px) {
    .article-layout { grid-template-columns: 1fr; }
    .toc-sidebar { position: static; }
    .related-grid { grid-template-columns: 1fr; }
    .newsletter-inline { flex-direction: column; }
    .article-meta { gap: var(--space-2); }
  }
</style>
